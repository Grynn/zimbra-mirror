#!/bin/bash
# 
# ***** BEGIN LICENSE BLOCK *****
# 
# Zimbra Collaboration Suite Server
# Copyright (C) 2005, 2006, 2007 Zimbra, Inc.
# 
# The contents of this file are subject to the Yahoo! Public License
# Version 1.0 ("License"); you may not use this file except in
# compliance with the License.  You may obtain a copy of the License at
# http://www.zimbra.com/license.
# 
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.
# 
# ***** END LICENSE BLOCK *****
# 

if [ x`whoami` != xzimbra ]; then
    echo Error: must be run as zimbra user
  exit 1
fi

platform=`/opt/zimbra/libexec/get_plat_tag.sh`

source `dirname $0`/zmshutil || exit 1
zmsetvars \
    zimbra_home \
    zimbra_log_directory

rewriteconfig() {
  /opt/zimbra/libexec/zmmtaconfig sasl > /dev/null 2>&1
}

#
# Main
#
case "$1" in
    'start')
    if [ -f ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid ]; then
      cpid=`cat ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid`
      kill -0 "$cpid" 2> /dev/null
      if [ $? -eq 0 ]; then
        exit 0
      fi
    fi
    mkdir -p ${zimbra_home}/cyrus-sasl-2.1.22.3z/state
    if [ x$2 = "x" ]; then
      rewriteconfig
    fi
    ${zimbra_home}/cyrus-sasl-2.1.22.3z/sbin/saslauthd -r -a zimbra 
        ;;

    'kill')
    cpid=`cat ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid`
        kill -TERM "$cpid" 2> /dev/null
        ;;

    'stop')
    if [ -f ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid ]; then
      cpid=`cat ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid`
      kill -TERM "$cpid" 2> /dev/null
    fi
    if [ -f ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid ]; then
      if [ x$platform = "xMACOSX" -o "x$platform" = "xMACOSXx86" ]; then
        killall -TERM saslauthd > /dev/null 2>&1
      else
        killall -TERM ${zimbra_home}/cyrus-sasl-2.1.22.3z/sbin/saslauthd > /dev/null 2>&1
      fi
    fi
    exit 0
        ;;
    
    'restart'|'reload')
        $0 stop
        $0 start
        ;;
  
  'status')
    cpid=`cat ${zimbra_home}/cyrus-sasl-2.1.22.3z/state/saslauthd.pid 2> /dev/null`
    kill -0 "$cpid" 2> /dev/null
    rc=$?
    if [ $rc = 0 ]; then
      echo "saslauthd is running with pid $cpid"
    else 
      echo "saslauthd is not running"
    fi
    exit $rc
    ;;
    
    *)
        echo "Usage: $0 start|stop|kill|restart|status"
        exit 1
        ;;
esac
