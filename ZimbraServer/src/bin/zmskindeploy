#!/bin/bash
# 
# ***** BEGIN LICENSE BLOCK *****
# 
# Zimbra Collaboration Suite Server
# Copyright (C) 2007 Zimbra, Inc.
# 
# The contents of this file are subject to the Yahoo! Public License
# Version 1.0 ("License"); you may not use this file except in
# compliance with the License.  You may obtain a copy of the License at
# http://www.zimbra.com/license.
# 
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.
# 
# ***** END LICENSE BLOCK *****
# 

# Set up the environment
BIN_ROOT=`dirname $0`

source ${BIN_ROOT}/zmshutil || exit 1
zmsetvars \
  zimbra_home \
  mailboxd_directory

SIMPLE_DATE=`date +%y%m%d%H%M%S`
BASE_URL=`${BIN_ROOT}/zmprov gacf ZimbraMailURL | sed -e 's/^[^:]*: //'`

CP="${mailboxd_directory}/webapps${BASE_URL}/WEB-INF/classes/"

usage() {
    echo "Usage: "`basename $0`" <path/to/skin/dir/or/zipfile>" >&2
#    echo "  -v              verbose" >&2
#    echo "  -n              make this deploy non-authoritative" >&2
#    echo "  -d              mark the package as defined" >&2
#    echo "  -p <prefix>     prefix to use on the output files (default '"$PREFIX"')" >&2
#    #echo "  -i <input dir>  base template input directory (defaults to .)" >&2
#    #echo "  -o <output dir> skin output directory (defaults to .)" >&2
    exit 2
}

# Check the number of arguments
if [ "$#" -ne "1" ]; then
    echo "Invalid argument(s)" >&2
    usage
fi

SKIN_SRC=$1
SKIN_WORK_BASE="${mailboxd_directory}/webapps${BASE_URL}"

# Make sure source exists, and copy it to working dir
if [ -d "$SKIN_SRC" ]; then
    SKIN_SRC_DIR=`cd $SKIN_SRC && pwd`
    SKIN_NAME=`basename $SKIN_SRC`
    SKIN_WORK_DIR="${SKIN_WORK_BASE}/skins/${SKIN_NAME}"

    if [ "$SKIN_WORK_DIR" != "$SKIN_SRC_DIR" ]; then
        if [ -e "$SKIN_WORK_DIR" ]; then
            rm -rf "$SKIN_WORK_DIR"
        fi
        cp -r "$SKIN_SRC_DIR" "$SKIN_WORK_DIR"
    fi
elif [ -f "$SKIN_SRC" ]; then
    # For now, assuming it is a .zip file.  Do we need to handle .tgz?
    SKIN_NAME=`basename $SKIN_SRC .zip`
    SKIN_WORK_DIR="${SKIN_WORK_BASE}/skins/${SKIN_NAME}"
    if [ -e $SKIN_WORK_DIR ]; then
        rm -rf $SKIN_WORK_DIR
    fi
    mkdir -p $SKIN_WORK_DIR

    # Macs add a resource dir to zip files, and "-n" prevents prompting
    # to overwrite it
    unzip -n -q $SKIN_SRC -d "$SKIN_WORK_DIR/.."
else
    echo "Invalid skin '$SKIN_SRC'" >&2
    usage
fi



SKIN_DEST_DIR="${SKIN_WORK_BASE}/skins/${SKIN_NAME}"

#if [ -e ${SKIN_DEST_DIR} ]; then
#    rm -rf ${SKIN_DEST_DIR}
#fi
#mkdir -p ${SKIN_DEST_DIR}

pushd $SKIN_WORK_DIR > /dev/null

TEMPLATES=`find . -type f -name \*.template`
if [ ${TEMPLATES} ]; then
    echo "Processing templates..."
    sh ${BIN_ROOT}/zmjava -cp "$CP" com.zimbra.kabuki.tools.templates.Template --prefix "${SKIN_NAME}" --authoritative  --inputdir ${SKIN_WORK_DIR} --outputdir ${SKIN_WORK_DIR} -- ${TEMPLATES} > /dev/null
fi

IMAGE_SUBDIRS=
for E in `find img -type d`; do
    if [ ${IMAGE_SUBDIRS} ]; then
        IMAGE_SUBDIRS="${IMAGE_SUBDIRS};"
    fi
    IMAGE_SUBDIRS="${IMAGE_SUBDIRS}${E}"
done


if [ ${IMAGE_SUBDIRS} ]; then
    echo "Processing images..."
    sh ${BIN_ROOT}/zmjava -cp "$CP" com.zimbra.kabuki.tools.img.ImageMerge --css-path "${BASE_URL}/skins/${SKIN_NAME}/" --css-file "img/images.css" --output ${SKIN_DEST_DIR} --input ${IMAGE_SUBDIRS} > /dev/null

    perl -pi -e 's/\@jsVersion\@/'$SIMPLE_DATE'/g' "${SKIN_DEST_DIR}/img/images.css"
fi

popd > /dev/null

${BIN_ROOT}/zmprov mcf +ZimbraInstalledSkin ${SKIN_NAME}

if [ $? = 0 ]; then
  echo "${SKIN_NAME} successfully installed." 
  echo "mailboxd restart is required to fully activate skin ${SKIN_NAME}"
fi

